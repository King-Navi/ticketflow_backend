post:
  tags: [Reservations]
  operationId: createReservation
  summary: Crea una reserva de uno o más asientos de evento
  description: >
    Crea una o varias reservas (holds) para uno o más `event_seat` de un evento que esté en venta.
    Valida que el evento exista y esté `on_sale`, que cada asiento pertenezca al evento,
    que no haya reservas activas/no expiradas y que no existan tickets bloqueantes.
    La expiración real se limita a un máximo de 15 minutos desde la creación,
    aunque el cliente envíe un valor mayor.
  security:
    - bearerAuth: []
  requestBody:
    required: true
    content:
      application/json:
        schema:
          type: object
          additionalProperties: false
          required:
            - event_id
            - event_seat_id
          properties:
            event_id:
              type: integer
              minimum: 1
              example: 42
            event_seat_id:
              description: >
                Puede ser un único ID de asiento de evento (integer) o un arreglo de IDs (integer[]).
                Cuando se envía un arreglo, el servicio intentará crear una reserva por cada asiento.
              oneOf:
                - type: integer
                  minimum: 1
                  example: 555
                - type: array
                  minItems: 1
                  items:
                    type: integer
                    minimum: 1
                  example: [555, 556, 557]
            expiration_at:
              type: string
              format: date-time
              description: >
                Opcional. Si se envía más de 15 minutos en el futuro,
                el servidor la recortará a 15 minutos desde ahora.
              example: "2025-11-06T15:30:00Z"
  responses:
    "201":
      description: Reserva(s) creada(s) y asiento(s) marcado(s) como reservado(s).
      content:
        application/json:
          schema:
            type: object
            required: [event, reservations, eventSeats]
            properties:
              event:
                type: object
                description: Evento validado (devuelto por el service).
              reservations:
                type: array
                description: >
                  Lista de reservas creadas. Si se envió un único `event_seat_id`,
                  normalmente contendrá un solo elemento.
                items:
                  type: object
                  properties:
                    reservation_id:
                      type: integer
                      example: 901
                    attendee_id:
                      type: integer
                      example: 101
                    event_seat_id:
                      type: integer
                      example: 555
                    status:
                      type: string
                      example: "active"
                    expiration_at:
                      type: string
                      format: date-time
                      example: "2025-11-06T15:45:00Z"
              eventSeats:
                type: array
                description: Asientos del evento actualizados a `reserved`.
                items:
                  type: object
                  description: Representación del asiento del evento ya actualizado.
    "400":
      description: Petición inválida (faltan campos o formato).
      content:
        application/json:
          schema:
            type: object
            required: [msg]
            properties:
              msg:
                type: string
                example: "event_id is required."
    "404":
      description: Recurso relacionado no encontrado (evento o asiento de evento).
      content:
        application/json:
          schema:
            type: object
            required: [msg]
            properties:
              msg:
                type: string
                example: "Event seat not found."
    "409":
      description: Conflicto de negocio (asiento ya reservado, ticket vendido o asiento no disponible).
      content:
        application/json:
          schema:
            type: object
            required: [msg]
            properties:
              msg:
                type: string
                example: "This seat is already reserved by someone else."
              meta:
                type: object
                description: Información adicional del conflicto.
          examples:
            seat_reserved:
              value:
                msg: "This seat is already reserved by someone else."
                meta:
                  reservation_id: 345
                  expires_at: "2025-11-06T15:45:00Z"
                  reserved_by_attendee_id: 101
                  current_attendee_id: 202
                  event_seat_id: 555
            ticket_blocking:
              value:
                msg: "This seat already has a sold/checked-in ticket."
                meta:
                  ticket_id: 777
                  ticket_status_id: 1
                  event_seat_id: 555
            seat_not_available:
              value:
                msg: "This seat is not available for reservation."
                meta:
                  current_status_id: 4
                  allowed_status_id: 1
                  event_seat_id: 555
    "503":
      description: No se pudo conectar a la base de datos.
      content:
        application/json:
          schema:
            type: object
            required: [msg]
            properties:
              msg:
                type: string
                example: "Cannot connect to the database."
    "500":
      description: Error interno no controlado.
      content:
        application/json:
          schema:
            type: object
            required: [msg]
            properties:
              msg:
                type: string
                example: "Error"
              detail:
                type: string
                example: "Unexpected error."
